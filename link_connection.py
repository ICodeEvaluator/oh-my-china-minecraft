import _utility, _md5, weakref, socket, random, os, struct, notify, chacha, network_proxy, time, binascii, setting, json, mcp_log, struct_util, neteaseHttp as http, application, mc_game_ctrl, log_mgr, pyaes
AQpwlMuHnoeddezGmswLfVzLmZNwDFBB = 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEArht9ioo6tc3Z7On/80iYjNI+HpxnEpSc0tXC9JLykvwkxluZiLPrlvO6sgkkPsQMBXudGRu335dBCVdwfMefY7wswrQG51U+Nw3xfSSRgSptNV8PcmNjh6EYAluRSy7AZLcWc6+qJ6fJFOeABGYxNwMVvbpDC0R+t7BtcmQCk+4uXP2dsRjJSs6ALlfT7iEs8IL7iRfu1IvomTAc6eJarStgxEBTWdV/d2XfoIshbNYQ9ziBk0iWzHoI15UXFWLL+jZwhQYwzB0f+ilckgFT0IFKU4msUUQ7io4CBY2iI1G0BnSQYwpm84WR0HrgKL7uoxtJQ98iPk2GbZgWFv1OTwIDAQAB'
JDDuZgctCsUFHXahIxAoZBBLhNRnQVIQ = '3f17d36cec77e47f1d301c0cc41cd73f'
fZpfxZvAKNkSouQjLezHUoPDXzaOgQYX = 'MIIEpAIBAAKCAQEAx/Ipxphk+HO16oMY8HBOpauKgrdBnuQpH3LhJzsEkgYVK88ObW8w5ts3e0+UWCRJYoCwxPT2CPKeUvJr86gt3ajaOSXEej9iudOUcU6C5bARmkET5EXGvRLH7dnqJt0X2oGUG7H4Okit8+4UydcbjLs3VfXZba73+zqVUWhJPnpm5bnVzrsqu/mDo/EuClH9zp8oWz2RQfyCdVPtCwmY8wg/nrrUZNVV/AbgchuTedUHgs0IQ7eqUEZTVWrUFkkv82OvWUlu2RFxfFw4e9cTzEJJVPGxLmowFpFNKzp206jP3uL23VdnHrI8m4CGOqIlyfXgfCfIu/NxbLnzRnbQpQIDAQABAoIBAEvGXciy1olGKOpAVsJAfb3RfgO9+bOC2obdnbClcDz66ykYJmqY2hqTd7pW1Wx2DA21ochy4Y9Qi2n6D6le0ksQA+vmgUinHv43zikGzRrJGFKyWRyIySG8rWJZ1KB35+NaekvorZ9BDhPE5cH8sKcsCHOeYZFs3vQqJo6cjC2NwBSC+8HzeO+Btcgz88FX46tFvNokeGuJqZEEcfhss5dggEdHiUKTJsRXIdxwXqnYv08uPEzn/ogsnCBc5+ujwwds2qxiua599J8lY5KbB3/kBVqtea2MYUX/JUNEAIQRm7ygJ0DJJKRjPO0vYnkxXWC2waY5cRBpKQiTmJVwvf0CgYEA7xA8816Y42zRk5eU1ngmVX1GEoVkK6wf0obIgSMHlrwKl5u4rb3Vu8qGIPZ/OPw6zIr+sfAmsR2hFy6mAjQrLsGoGmegU1s6Ogr5fqMw55/OWv7tEhfI+myX2N9xw9IpodBsFfvd8yDDMmByiFtFx1oGu41VbbAJZdvsdlBIyV8CgYEA1hx5DspkRth44zIzgV+7EmCRSghCJ0c85MJwohpXX2wKg09gWm9AuuH74DEo0akIZGIRUZqxelMh3dc/mKmQmoMRbfMJojb7fytw3CtZEDNiXXDBtrZW2FFrwixK8XzFCKjYxwqOCt+kYbQcCz7MABWUb+heUxH+QMYtXTRr8HsCgYEAqup6GSktt5NKNvItmDQofABng8BYgJy716FDYogv2cWw8PmFTLonP+6ofJKfHJfAVhKdy4u9re1YCaHxUCwKH5CW5eHmjxHvDCZif/aedUsclpQh3EijCN9wpL4DsRPlben8DK+Y3EU1KSQpXnGa7s7fd2GxjQ1JesiEQ4Zcs5MCgYEAkdfpOgLw1TUk+xU58jkkMztmG/iOHzUuLGCp2jF5LH1ql9Ecv90iSWofaLHzrQSnu8D1LRHjLICuA+9X2YQ/BJCc8bjn6f/rxc7wXHiGfTuTGDTzLqL7evPTI/uJvP6RM/nXV5U/9fYqgYbux1YqHTCV4Lh2b71E5BhZ1DAeCjsCgYA5taKd1CCN1KyflOpiDJPskQSBdF9wO+P+dUdmFZDNccUFk2rNQ63idcH/n2L258Wf9SiI2dDjaaxUEetP3Ei75eHf4ixw22zlZ/kl+/BPWBdmTb+22xzoVMnt/ya/kvEC27/GAbrV4v+c5WFTs+ExWWkYbrpYJ6LnxAHiNf7/Uw=='
sOQRZSJZOlVdZjpYdPnrslXAaCAZeqoy = 10
VOzGuFoaqauYMnrlopQHIdyKSnqNHXjG = 0.5
oUVEazqnaCMsXmTiZydGYqOOCmidwzkc = 2
RMBVtidFASyCpGRxIRCItZAKbYgFwQag = 5 * 60
lkotUBFlCCQnrqGmcSdWCbePWYFrCVhe = struct.pack('<B', 0)
class NkOTBlPmQEgLNgELfnSvVCgtUoXQZqEc(object):
    def __init__(self, owner):
        self._owner = weakref.ref(owner)
        self._link_server_url = ''
        self._encrypter = None
        self._decrypter = None
        self._socket = None
        self._send_queue = []
        self._recv_buff = ''
        self._handshake_flag = False
        self._last_heartbeat_time = 0
        self._err_connect_queue = [2, 2, 2, 2, 2]
        self._last_force_quit_time = 0
        self.throttle_limit_time = 0
        self._current_fail_times = 0
        self._last_no_data_time = 0
        self._online = False
        self._last_reconnect_time = 0
        self._next_reconnect_time = 0
        notify.register_handle('on_tick_update', self, self.MvigUAUTzRpiSCfpyrahmCMyZlbrvbtD)
        return
    def __del__(self):
        notify.unregist_handle('on_tick_update', self, self.MvigUAUTzRpiSCfpyrahmCMyZlbrvbtD)
    def elBXPyVoqvrQgQRMqfAFiFnoWMlJfEBq(self, link_server_url):
        if not link_server_url:
            return
        self._link_server_url = link_server_url
        mcp_log.info('link server url: %s', link_server_url)
        DVPQWMrnQoqgmrKFgJSMretlVpJdkWtU = http.GetClientIns().HttpConnection(link_server_url)
        def GnBTByeGJzZZCRqcTuucRnVRdExWxjxR(response):
            if http.HttpResponse.get_response_code(response) != 200:
                mcp_log.info('link server init Link Server List Object Failure.')
                self.acbQNNpJunDeqxAFZDNJIQdSyQkXcOlj('link_server_list http code error')
                return
            tanpUWXyJlgkhAmpQXCyiWnGoKxHZFaT = json.loads(http.HttpResponse.get_response_body(response).decode('utf8'))
            if not tanpUWXyJlgkhAmpQXCyiWnGoKxHZFaT:
                mcp_log.info('link server Init Link Server List Object Failure++++')
                self.acbQNNpJunDeqxAFZDNJIQdSyQkXcOlj('link_server_list not found')
                return
            tanpUWXyJlgkhAmpQXCyiWnGoKxHZFaT = [mbSOGLiMbDdNbNomMjObNQKEiHEVlQax for mbSOGLiMbDdNbNomMjObNQKEiHEVlQax in tanpUWXyJlgkhAmpQXCyiWnGoKxHZFaT if str(mbSOGLiMbDdNbNomMjObNQKEiHEVlQax.get('status', 0)) == '1']
            lRRudUgSyNRpzZnDqoOsMdmPwssMmolx = random.choice(tanpUWXyJlgkhAmpQXCyiWnGoKxHZFaT)
            self._handshake_flag = False
            self._send_queue = []
            self._recv_buff = ''
            self._last_no_data_time = 0
            self._next_reconnect_time = 0
            rnLNVqWshSwQqCajbBFEApLVmNTuQfOi = lRRudUgSyNRpzZnDqoOsMdmPwssMmolx['ip'].encode('utf-8')
            ImnVzSPDXKcHgMPgFgSEdmMBmusshpUy = lRRudUgSyNRpzZnDqoOsMdmPwssMmolx['port']
            ONLriOillXDcjRBFfsHJuCyYaZBBtgBN = lRRudUgSyNRpzZnDqoOsMdmPwssMmolx.get('ipv6_Enabled', 0)
            xYMywdCzCvupscjOhKqLIFVBtLQiJTjj = getattr(socket, 'AI_DEFAULT', socket.AI_ADDRCONFIG) if socket.has_ipv6 else 0
            wGlbpTeYoyTOEMckMXyCulRXwSDUZkXJ = {'server_name': 'link_server', 
               'origin_ip': rnLNVqWshSwQqCajbBFEApLVmNTuQfOi, 
               'origin_port': ImnVzSPDXKcHgMPgFgSEdmMBmusshpUy, 
               'harbor_err': 0, 
               'provider': 'bgp', 
               'new_ip': rnLNVqWshSwQqCajbBFEApLVmNTuQfOi, 
               'new_port': ImnVzSPDXKcHgMPgFgSEdmMBmusshpUy, 
               'lighten_url': '', 
               'ipv6_enable': ONLriOillXDcjRBFfsHJuCyYaZBBtgBN, 
               'network_ipv6': False, 
               'lighten_server': False}
            def IggIoLbjScuJvrwWXnclZgscTXQIHCOD(params):
                try:
                    eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk = socket.getaddrinfo(params['new_ip'], params['new_port'], socket.AF_UNSPEC, socket.SOCK_STREAM, 0, xYMywdCzCvupscjOhKqLIFVBtLQiJTjj)
                    mcp_log.info('link server startConnect first time addrinfos %s %s', xYMywdCzCvupscjOhKqLIFVBtLQiJTjj, eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk)
                except:
                    eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk = socket.getaddrinfo(params['new_ip'], params['new_port'], socket.AF_UNSPEC, socket.SOCK_STREAM, 0, socket.AI_ADDRCONFIG)
                    mcp_log.info('link server startConnect second time addrinfos %s %s', xYMywdCzCvupscjOhKqLIFVBtLQiJTjj, eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk)
                def yHFVLyKWAhWeQdxZPxqgieGsNkYGODqE(fail_callback, eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk):
                    if not eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk:
                        self.acbQNNpJunDeqxAFZDNJIQdSyQkXcOlj('link server getaddrinfo error')
                        raise socket.error('link server getaddrinfo returns an empty list')
                    random.shuffle(eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk)
                    RZPcqaJNyXSlzoLQweVoXVheoAVCxlkB = eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk[0]
                    PIEvRPlIJnslrhIMBoyuevFmBdkFzKPc, QOhzyiknUHCRubenaOxfnwlrzlklbNKo, TEKbgCSUjSGkVIntnScELrblUABvFtwC, skHUbfGQgKawnZGmPyWWqxcvAvIHYnfU, sgNmkbdtfnSypADWtouFTYkWnKOkuSTR = RZPcqaJNyXSlzoLQweVoXVheoAVCxlkB
                    mcp_log.info('link server startConnect addrinfo %s', RZPcqaJNyXSlzoLQweVoXVheoAVCxlkB)
                    self._socket = socket.socket(PIEvRPlIJnslrhIMBoyuevFmBdkFzKPc, QOhzyiknUHCRubenaOxfnwlrzlklbNKo, TEKbgCSUjSGkVIntnScELrblUABvFtwC)
                    sgNmkbdtfnSypADWtouFTYkWnKOkuSTR = list(sgNmkbdtfnSypADWtouFTYkWnKOkuSTR)
                    sgNmkbdtfnSypADWtouFTYkWnKOkuSTR[1] = params['new_port']
                    self._socket.settimeout(3)
                    try:
                        self._socket.connect(tuple(sgNmkbdtfnSypADWtouFTYkWnKOkuSTR))
                        self._socket.setblocking(False)
                        self.ciper_r1 = os.urandom(16)
                        mcp_log.info('link server ciper r1: %s', binascii.hexlify(self.ciper_r1))
                        cUtFVcurswOfZhcAmMjHTsCaUlJxylCZ = _utility.rsa_encrypt(self.ciper_r1, AQpwlMuHnoeddezGmswLfVzLmZNwDFBB)
                        hqMojTzKkULZAhTdJrzlnnVotTztWQKg = _md5.new()
                        hqMojTzKkULZAhTdJrzlnnVotTztWQKg.update(AQpwlMuHnoeddezGmswLfVzLmZNwDFBB)
                        xGXDcfNdYHhSSaaqKklxqTpNPfGNwpeF = hqMojTzKkULZAhTdJrzlnnVotTztWQKg.digest()
                        xGXDcfNdYHhSSaaqKklxqTpNPfGNwpeF = binascii.unhexlify(JDDuZgctCsUFHXahIxAoZBBLhNRnQVIQ)
                        self._socket.send(cUtFVcurswOfZhcAmMjHTsCaUlJxylCZ)
                        self._socket.send(xGXDcfNdYHhSSaaqKklxqTpNPfGNwpeF)
                    except socket.error as ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb:
                        mcp_log.warning('link server socket connect error: %s', ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb)
                        self.acbQNNpJunDeqxAFZDNJIQdSyQkXcOlj('link server socket error')
                        if self._socket is not None:
                            self._socket.close()
                        fail_callback()
                    return
                def KxJlzPbxtzAurngiqMiJCXdEDcAOiLLk():
                    if params['new_ip'] != params['origin_ip']:
                        def KizsYFFDIcptEYRinrMDMeZhufrMFQEi():
                            mcp_log.info('link server origin_port connect fail')
                        try:
                            eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk = socket.getaddrinfo(params['origin_ip'], params['origin_port'], socket.AF_UNSPEC, socket.SOCK_STREAM, 0, xYMywdCzCvupscjOhKqLIFVBtLQiJTjj)
                            mcp_log.info('link server startConnect third time addrinfos %s %s', xYMywdCzCvupscjOhKqLIFVBtLQiJTjj, eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk)
                        except:
                            eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk = socket.getaddrinfo(params['origin_ip'], params['origin_port'], socket.AF_UNSPEC, socket.SOCK_STREAM, 0, socket.AI_ADDRCONFIG)
                            mcp_log.warning('link server startConnect except addrinfos %s', eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk)
                        yHFVLyKWAhWeQdxZPxqgieGsNkYGODqE(KizsYFFDIcptEYRinrMDMeZhufrMFQEi, eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk)
                yHFVLyKWAhWeQdxZPxqgieGsNkYGODqE(KxJlzPbxtzAurngiqMiJCXdEDcAOiLLk, eZhbeWxepjKgMXPvqTjLfNUTqRXOHcqk)
            network_proxy.try_use_ipv6(wGlbpTeYoyTOEMckMXyCulRXwSDUZkXJ, IggIoLbjScuJvrwWXnclZgscTXQIHCOD, IggIoLbjScuJvrwWXnclZgscTXQIHCOD)
        DVPQWMrnQoqgmrKFgJSMretlVpJdkWtU.set_callback(GnBTByeGJzZZCRqcTuucRnVRdExWxjxR)
        DVPQWMrnQoqgmrKFgJSMretlVpJdkWtU.sendRequest(http.HTTP_METHOD_GET)
    def zUgZLSKZTiNWJiIQYkAXjeJWgsHbtBCs(self):
        return self._online
    def GLmojDmXireqJudfUpigPeeViilvjoiz(self):
        self._online = False
        iNWeudqGWwgXUgrZxgeyGsnGOynyoDDJ = time.time()
        if iNWeudqGWwgXUgrZxgeyGsnGOynyoDDJ - self._last_reconnect_time < 15:
            return
        else:
            if not application.instance._login_time:
                return
            self._last_reconnect_time = time.time()
            mcp_log.info('link server start reconnect')
            try:
                if self._socket is not None:
                    self._socket.close()
                if self._encrypt_key is not None:
                    chacha.delete_chacha(8, self._encrypt_key)
                    self._encrypter = None
                if self._decrypt_key is not None:
                    chacha.delete_chacha(8, self._decrypt_key)
                    self._decrypter = None
                self.elBXPyVoqvrQgQRMqfAFiFnoWMlJfEBq(self._link_server_url)
                mcp_log.info('link server finish reconnect')
            except:
                mcp_log.warning('link server reconnect fail, current fail time: %s', self._current_fail_times)
            return
    def HEZNLoEkawbSqBHLKtOjKavNhmRvldjd(self):
        if self._socket is None:
            return
        else:
            self._socket.close()
            self._socket = None
            return
    def qxFfNpbFpTnNsSaRMIUodsPlgpNnIJlt(self, XUAWLGWAYsaOPLRnoWDSciQYAMncQsuN, HNNVyxGvuorieKsYFxTUrxctdwalvqlx, eLAHtXtGxzwJSGvCLDqgJfwdJJrvnHsx, qkpklGvFGfRbKTDztKzHmhesEHPNzNwV=False):
        if self._encrypter is None:
            return
        try:
            kejWDupUZMTpZJwChjOAyrwLsmhNbreS = struct_util.easy_pack_varint(XUAWLGWAYsaOPLRnoWDSciQYAMncQsuN) + struct.pack('<B', 0) + struct.pack('<B', len(HNNVyxGvuorieKsYFxTUrxctdwalvqlx)) + HNNVyxGvuorieKsYFxTUrxctdwalvqlx + eLAHtXtGxzwJSGvCLDqgJfwdJJrvnHsx
            VjiwmmeoNKWNpjtOoDtEOrYUswAuMOhv = self._encrypter.get_encrypted_text(kejWDupUZMTpZJwChjOAyrwLsmhNbreS, len(kejWDupUZMTpZJwChjOAyrwLsmhNbreS))
            if qkpklGvFGfRbKTDztKzHmhesEHPNzNwV and not self._socket:
                mcp_log.info('send immediately change to false, socket is None')
                qkpklGvFGfRbKTDztKzHmhesEHPNzNwV = False
            if not qkpklGvFGfRbKTDztKzHmhesEHPNzNwV:
                self._send_queue.append(VjiwmmeoNKWNpjtOoDtEOrYUswAuMOhv)
            else:
                bvgBinqWqdiCaBImhnImvubAzfJhPQbV = struct_util.easy_pack_varint(len(VjiwmmeoNKWNpjtOoDtEOrYUswAuMOhv))
                bvgBinqWqdiCaBImhnImvubAzfJhPQbV += VjiwmmeoNKWNpjtOoDtEOrYUswAuMOhv
                self._socket.send(bvgBinqWqdiCaBImhnImvubAzfJhPQbV)
        except Exception as ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb:
            self.acbQNNpJunDeqxAFZDNJIQdSyQkXcOlj('link server sendMessage error')
            mcp_log.warning('link server sendMessage error: %s', ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb)
        return
    def DPhIcerxfXkjgahTDypsgdPjRIIvJOZu(self, dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd):
        try:
            dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd = self._decrypter.get_encrypted_text(dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd, len(dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd))
            UEMADhERGQVsjtXfcoIgqHbmLyopTxue = struct_util.easy_unpack_varint(dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd)
            XUAWLGWAYsaOPLRnoWDSciQYAMncQsuN = UEMADhERGQVsjtXfcoIgqHbmLyopTxue[0]
            dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd = dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd[UEMADhERGQVsjtXfcoIgqHbmLyopTxue[1]:]
            auMPInzZMWlljTzjAwfKlKaenMVCyQne = struct.unpack('<B', dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd[:1])[0]
            dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd = dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd[1:]
            GRCziwBAQgCLTQHlCTNpDYjzdnkVOxLW = struct.unpack('<B', dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd[:1])[0]
            HNNVyxGvuorieKsYFxTUrxctdwalvqlx = dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd[1:1 + GRCziwBAQgCLTQHlCTNpDYjzdnkVOxLW]
            dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd = dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd[1 + GRCziwBAQgCLTQHlCTNpDYjzdnkVOxLW:]
            eLAHtXtGxzwJSGvCLDqgJfwdJJrvnHsx = json.loads(dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd)
            if self.gPMJLwxjNHejcEDXqIZFdqqyjjJuxUyQ(auMPInzZMWlljTzjAwfKlKaenMVCyQne, 1) and not self._next_reconnect_time:
                self._next_reconnect_time = time.time() + random.randint(5, 605)
                mcp_log.info('link server will reconnect in %s time', self._next_reconnect_time)
                return
            if eLAHtXtGxzwJSGvCLDqgJfwdJJrvnHsx.get('code') == 16777222:
                self.throttle_limit_time += 60
                self._next_reconnect_time = time.time() + self.throttle_limit_time
                return
            if not self.gPMJLwxjNHejcEDXqIZFdqqyjjJuxUyQ(auMPInzZMWlljTzjAwfKlKaenMVCyQne, 1):
                self.throttle_limit_time = 0
                self._next_reconnect_time = 0
            if HNNVyxGvuorieKsYFxTUrxctdwalvqlx == 'LoginV2':
                if eLAHtXtGxzwJSGvCLDqgJfwdJJrvnHsx.get('code') == 0:
                    self._online = True
                    self._current_fail_times = 0
                    self._owner().onFinishReconnect()
                    mcp_log.info('link server login success')
                else:
                    self._next_reconnect_time = time.time() + random.randint(0, 5)
                    mcp_log.info('link server will reconnect in %s time 11', self._next_reconnect_time)
            self._owner().handle(XUAWLGWAYsaOPLRnoWDSciQYAMncQsuN, HNNVyxGvuorieKsYFxTUrxctdwalvqlx, eLAHtXtGxzwJSGvCLDqgJfwdJJrvnHsx)
        except Exception as ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb:
            mcp_log.warning('link server recvMessage error: %s', ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb)
    def KzRKKuPEYnlfZtureqSHqxyvIDcimgMR(self):
        if not self._socket:
            return
        self._socket.send(lkotUBFlCCQnrqGmcSdWCbePWYFrCVhe)
    def MvigUAUTzRpiSCfpyrahmCMyZlbrvbtD(self):
        if not self._socket:
            return
        self.CKaNTcXgPavUZNTrnIFJteyVCEjKuhpO()
        self.vKcqpLLjxLmbqYnSMrUIBDEFlzjFYfmr()
    def CKaNTcXgPavUZNTrnIFJteyVCEjKuhpO(self):
        try:
            iNWeudqGWwgXUgrZxgeyGsnGOynyoDDJ = time.time()
            if self._current_fail_times > 3:
                self.BrTTwXyHOqohXtTdwKPTIwMNAmoyxmpa(3)
                self._current_fail_times = 0
                return
            if self._next_reconnect_time:
                if self._next_reconnect_time - iNWeudqGWwgXUgrZxgeyGsnGOynyoDDJ < 0:
                    mcp_log.info('link server reconnect start')
                    self._last_reconnect_time = 0
                    self._next_reconnect_time = 0
                    self.GLmojDmXireqJudfUpigPeeViilvjoiz()
                if self.throttle_limit_time > 0:
                    return
            if len(self._send_queue) == 0:
                if iNWeudqGWwgXUgrZxgeyGsnGOynyoDDJ - self._last_heartbeat_time > sOQRZSJZOlVdZjpYdPnrslXAaCAZeqoy:
                    self._last_heartbeat_time = iNWeudqGWwgXUgrZxgeyGsnGOynyoDDJ
                    if self._current_fail_times > 0:
                        if self._owner().anti_addition_status:
                            yRdCHbQetAvINhBIXcFzeaPjGBubqomf = -(sOQRZSJZOlVdZjpYdPnrslXAaCAZeqoy - random.randint(0, 5))
                        else:
                            yRdCHbQetAvINhBIXcFzeaPjGBubqomf = random.randint(5, 35)
                            if self._current_fail_times >= 4 and self._current_fail_times <= 6:
                                yRdCHbQetAvINhBIXcFzeaPjGBubqomf = random.randint(5, 305)
                            elif self._current_fail_times > 6:
                                yRdCHbQetAvINhBIXcFzeaPjGBubqomf = random.randint(5, 605)
                        mcp_log.info('link server add reconnect time by %s %s', yRdCHbQetAvINhBIXcFzeaPjGBubqomf, self._current_fail_times)
                        self._last_heartbeat_time += yRdCHbQetAvINhBIXcFzeaPjGBubqomf
                    self._socket.send(lkotUBFlCCQnrqGmcSdWCbePWYFrCVhe)
                return
            bvgBinqWqdiCaBImhnImvubAzfJhPQbV = ''
            for pWMtyOIHZprstcBLMlcFbVTbVEJNYeAT in self._send_queue:
                bvgBinqWqdiCaBImhnImvubAzfJhPQbV += struct_util.easy_pack_varint(len(pWMtyOIHZprstcBLMlcFbVTbVEJNYeAT))
                bvgBinqWqdiCaBImhnImvubAzfJhPQbV += pWMtyOIHZprstcBLMlcFbVTbVEJNYeAT
            self._send_queue = []
            self._socket.send(bvgBinqWqdiCaBImhnImvubAzfJhPQbV)
        except Exception as ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb:
            mcp_log.warning('link server handleSendInTick error: %s', ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb)
            self._current_fail_times += 1
            self.GLmojDmXireqJudfUpigPeeViilvjoiz()
            del self._err_connect_queue[0]
            self._err_connect_queue.append(time.time())
            if time.time() - self._err_connect_queue[0] < 300:
                self.BrTTwXyHOqohXtTdwKPTIwMNAmoyxmpa(4)
                self._err_connect_queue = [2, 2, 2, 2, 2]
    def vKcqpLLjxLmbqYnSMrUIBDEFlzjFYfmr(self):
        if not self._socket:
            return
        iNWeudqGWwgXUgrZxgeyGsnGOynyoDDJ = time.time()
        try:
            if iNWeudqGWwgXUgrZxgeyGsnGOynyoDDJ - self._last_no_data_time >= VOzGuFoaqauYMnrlopQHIdyKSnqNHXjG:
                zpFisIRvYXGefymzqLBsekzNPGVdwlVG = self._socket.recv(2048)
                if len(zpFisIRvYXGefymzqLBsekzNPGVdwlVG) != 0:
                    self._recv_buff += zpFisIRvYXGefymzqLBsekzNPGVdwlVG
        except socket.error as ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb:
            if ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb.errno in (11, 35, 10035):
                self._last_no_data_time = iNWeudqGWwgXUgrZxgeyGsnGOynyoDDJ
        if len(self._recv_buff) < 2:
            return
        if not self._handshake_flag:
            kUWzpcyeKPjWlzsGQHfYprvABRutbBiT = self._recv_buff
            self._recv_buff = ''
            self.YSyQDiZJIJjKdLMjzHbigGdmjxdXsFKu(kUWzpcyeKPjWlzsGQHfYprvABRutbBiT)
            return
        QWFgEyCBDtaSotGpwPvSOWhpHgVxdxQs = struct_util.easy_unpack_varint(self._recv_buff)
        jzAkoZHEQiRadRhhRpWANPnbvXVKzZpv = QWFgEyCBDtaSotGpwPvSOWhpHgVxdxQs[1]
        JQJTzjqgpYnCSTGBFUDkAzIutdJlAcVP = QWFgEyCBDtaSotGpwPvSOWhpHgVxdxQs[0]
        if len(self._recv_buff) < jzAkoZHEQiRadRhhRpWANPnbvXVKzZpv + JQJTzjqgpYnCSTGBFUDkAzIutdJlAcVP:
            mcp_log.info('link server recv message not enough')
            return
        if JQJTzjqgpYnCSTGBFUDkAzIutdJlAcVP == 0:
            self._recv_buff = self._recv_buff[jzAkoZHEQiRadRhhRpWANPnbvXVKzZpv:]
            mcp_log.info('link server recv message empty')
            return
        dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd = self._recv_buff[jzAkoZHEQiRadRhhRpWANPnbvXVKzZpv:jzAkoZHEQiRadRhhRpWANPnbvXVKzZpv + JQJTzjqgpYnCSTGBFUDkAzIutdJlAcVP]
        self._recv_buff = self._recv_buff[jzAkoZHEQiRadRhhRpWANPnbvXVKzZpv + JQJTzjqgpYnCSTGBFUDkAzIutdJlAcVP:]
        self.DPhIcerxfXkjgahTDypsgdPjRIIvJOZu(dpIbvvMXAcvNPzBogcgILVxOdUgkjNSd)
    def YSyQDiZJIJjKdLMjzHbigGdmjxdXsFKu(self, kUWzpcyeKPjWlzsGQHfYprvABRutbBiT):
        mcp_log.info('link server ciper r2 encrypt：%s', binascii.hexlify(kUWzpcyeKPjWlzsGQHfYprvABRutbBiT))
        try:
            bJnMeXKzrdpXsBibgpolTpPyubMbhTvn = _utility.rsa_decrypt(kUWzpcyeKPjWlzsGQHfYprvABRutbBiT, fZpfxZvAKNkSouQjLezHUoPDXzaOgQYX)
            self.bJnMeXKzrdpXsBibgpolTpPyubMbhTvn = bJnMeXKzrdpXsBibgpolTpPyubMbhTvn.strip('\x00')
        except Exception as ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb:
            mcp_log.warning('link server handleHandleShakeRecv error: %s', ifBnggGvpcHwUlBDYpdIRjPWaAvJWVIb)
        mcp_log.info('link server ciper r2：%s', binascii.hexlify(self.bJnMeXKzrdpXsBibgpolTpPyubMbhTvn))
        self._handshake_flag = True
        self._encrypt_key = self.ciper_r1 + self.bJnMeXKzrdpXsBibgpolTpPyubMbhTvn
        self._decrypt_key = self.bJnMeXKzrdpXsBibgpolTpPyubMbhTvn + self.ciper_r1
        self._encrypter = chacha.get_chacha(8, self._encrypt_key)
        self._decrypter = chacha.get_chacha(8, self._decrypt_key)
        self.VkttMChrcVbQyNXeLqWBaeLxFmZbAdNu()
    def VkttMChrcVbQyNXeLqWBaeLxFmZbAdNu(self):
        SSvlSCccKUgXZdehoIbNyNFnPTqZgSxu = setting.get_encryped_login_token()
        qRGCpEwFIFETdxMrDpxtiPQMbMbHFYKI = os.urandom(16)
        DTQNfqiOKAECJntTOXcBnQJuoPJwnuUb = pyaes.AESModeOfOperationECB(SSvlSCccKUgXZdehoIbNyNFnPTqZgSxu).encrypt(qRGCpEwFIFETdxMrDpxtiPQMbMbHFYKI)
        eLAHtXtGxzwJSGvCLDqgJfwdJJrvnHsx = {'uid': (int(setting.get_login_uid())), 
           's1': (binascii.hexlify(qRGCpEwFIFETdxMrDpxtiPQMbMbHFYKI)), 
           's2': (binascii.hexlify(DTQNfqiOKAECJntTOXcBnQJuoPJwnuUb))}
        self.qxFfNpbFpTnNsSaRMIUodsPlgpNnIJlt(0, 'LoginV2', json.dumps(eLAHtXtGxzwJSGvCLDqgJfwdJJrvnHsx))
    def acbQNNpJunDeqxAFZDNJIQdSyQkXcOlj(self, pWMtyOIHZprstcBLMlcFbVTbVEJNYeAT):
        uKRqNrOvySAixQNEYatMZEwPZxRxiHlg = {'type': 'link_server', 
           'sub_type': 'link_server_connect_fail', 
           'game_info': (mc_game_ctrl.instance._cur_game_info), 
           'device_info': (log_mgr.instance.make_common_fields()), 
           'uid': (setting.get_login_uid()), 
           'code': (-1), 
           'message': pWMtyOIHZprstcBLMlcFbVTbVEJNYeAT}
        mcp_log.info('sendConnectErrorLog %s', uKRqNrOvySAixQNEYatMZEwPZxRxiHlg)
        uKRqNrOvySAixQNEYatMZEwPZxRxiHlg = {'msg': (json.dumps(uKRqNrOvySAixQNEYatMZEwPZxRxiHlg))}
        self._owner().send_req(application.instance.GetApiGatewayUrl(), '/client-log', uKRqNrOvySAixQNEYatMZEwPZxRxiHlg)
    def gPMJLwxjNHejcEDXqIZFdqqyjjJuxUyQ(self, num, bit):
        return num >> bit - 1 & 1
    def BrTTwXyHOqohXtTdwKPTIwMNAmoyxmpa(self, code):
        iQKQobJBZFfmFlmNjGNEgdXXBeNAQvIr = time.time()
        if iQKQobJBZFfmFlmNjGNEgdXXBeNAQvIr - self._last_force_quit_time < 30:
            return
        else:
            self._last_force_quit_time = iQKQobJBZFfmFlmNjGNEgdXXBeNAQvIr
            mcp_log.info('link server forceQuitGame: %s', code)
            XCTGMQvwCDneLHtXHOCSJGcTuAucJwNr = application.instance.getModuleSwitch() or {}
            dKTUXvajUHgyxLrHTMQGTjiRoopcUrBq = XCTGMQvwCDneLHtXHOCSJGcTuAucJwNr.get('EnableForceConnectLinkServer', None)
            fdYnuNBaOirTVgEmpPQaDHdxhaNXGMec = XCTGMQvwCDneLHtXHOCSJGcTuAucJwNr.get('EnableForceConnectLinkServerLog', None)
            if dKTUXvajUHgyxLrHTMQGTjiRoopcUrBq:
                self._owner().BrTTwXyHOqohXtTdwKPTIwMNAmoyxmpa(0, '您已断开连接', '')
            uKRqNrOvySAixQNEYatMZEwPZxRxiHlg = {'type': 'link_server_connect_fail', 
               'data': {'code': code, 
                        'game_info': (mc_game_ctrl.instance._cur_game_info), 
                        'device_info': (log_mgr.instance.make_common_fields()), 
                        'last_five_error_time': (self._err_connect_queue)}}
            if fdYnuNBaOirTVgEmpPQaDHdxhaNXGMec:
                self._owner().send_req(application.instance.GetApiGatewayUrl(), '/salog', uKRqNrOvySAixQNEYatMZEwPZxRxiHlg)
            return
